<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hamish & Jazz Health Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .sync-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .sync-status.connected {
            background: linear-gradient(135deg, #34d399, #10b981);
            color: white;
        }
        
        .sync-status.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .person-card h2 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .person-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .hamish-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .jazz-icon { background: linear-gradient(135deg, #ec4899, #be185d); }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        input[type="date"], input[type="number"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input[type="date"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .btn-secondary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(100, 116, 139, 0.4);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .chart-header h2 {
            color: #333;
            margin: 0;
        }
        
        .time-range-buttons {
            display: flex;
            gap: 10px;
        }
        
        .time-btn {
            padding: 6px 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .time-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }
        
        .time-btn:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }
        
        .chart-canvas-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .week-drinks {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .day-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background: #f8fafc;
            min-width: 80px;
        }
        
        .day-indicator.has-drinks {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }
        
        .day-indicator.no-drinks {
            background: linear-gradient(135deg, #34d399, #10b981);
            color: white;
        }
        
        .day-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .drink-count {
            font-size: 1.2em;
        }
        
        .points-display {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e2e8f0;
        }
        
        .points-person {
            text-align: center;
        }
        
        .points-person .name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #666;
        }
        
        .points-person .points {
            font-size: 2em;
            font-weight: bold;
        }
        
        .points-positive { color: #10b981; }
        .points-negative { color: #ef4444; }
        .points-neutral { color: #6b7280; }
        
        .edit-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }
        
        .edit-section h3 {
            color: #666;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .previous-data {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .data-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .data-entry:hover {
            background: #e2e8f0;
        }
        
        .data-date {
            font-weight: 600;
            color: #333;
        }
        
        .data-values {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 14px;
        }
        
        .edit-btn {
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .edit-btn:hover {
            background: #764ba2;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .modal-body .input-group {
            margin-bottom: 15px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn-cancel {
            background: #e2e8f0;
            color: #333;
        }
        
        .btn-cancel:hover {
            background: #cbd5e1;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏃‍♂️ Health Tracker 🏃‍♀️</h1>
        
        <div class="sync-status" id="syncStatus">
            <span id="syncText">Connecting to Firebase...</span>
        </div>
        
        <div class="main-grid">
            <div class="card person-card">
                <h2>
                    <span class="person-icon hamish-icon">H</span>
                    Hamish
                </h2>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="hamish-date" />
                </div>
                <div class="input-group">
                    <label>Drinks Today</label>
                    <div class="input-row">
                        <input type="number" id="hamish-drinks" min="0" value="0" />
                        <button class="btn btn-primary" onclick="saveData('hamish')">Save</button>
                    </div>
                </div>
                <div class="input-group">
                    <label>Exercise (minutes)</label>
                    <input type="number" id="hamish-exercise" min="0" value="0" />
                </div>
                <div class="input-group">
                    <label>Weight (kg)</label>
                    <input type="number" id="hamish-weight" min="0" step="0.1" placeholder="Optional" />
                </div>
                
                <div class="edit-section">
                    <h3>Edit Previous Entries</h3>
                    <button class="btn btn-secondary" onclick="loadPreviousData('hamish')">Load Previous Data</button>
                    <div class="previous-data" id="hamish-previous"></div>
                </div>
            </div>
            
            <div class="card person-card">
                <h2>
                    <span class="person-icon jazz-icon">J</span>
                    Jazz
                </h2>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="jazz-date" />
                </div>
                <div class="input-group">
                    <label>Drinks Today</label>
                    <div class="input-row">
                        <input type="number" id="jazz-drinks" min="0" value="0" />
                        <button class="btn btn-primary" onclick="saveData('jazz')">Save</button>
                    </div>
                </div>
                <div class="input-group">
                    <label>Exercise (minutes)</label>
                    <input type="number" id="jazz-exercise" min="0" value="0" />
                </div>
                <div class="input-group">
                    <label>Weight (kg)</label>
                    <input type="number" id="jazz-weight" min="0" step="0.1" placeholder="Optional" />
                </div>
                
                <div class="edit-section">
                    <h3>Edit Previous Entries</h3>
                    <button class="btn btn-secondary" onclick="loadPreviousData('jazz')">Load Previous Data</button>
                    <div class="previous-data" id="jazz-previous"></div>
                </div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Points</h3>
                <div class="points-display">
                    <div class="points-person">
                        <div class="name">Hamish</div>
                        <div class="points" id="hamish-total-points">0</div>
                    </div>
                    <div class="points-person">
                        <div class="name">Jazz</div>
                        <div class="points" id="jazz-total-points">0</div>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <h3>This Week's Performance</h3>
                <div class="points-display">
                    <div class="points-person">
                        <div class="name">Hamish</div>
                        <div class="points" id="hamish-week-points">0</div>
                    </div>
                    <div class="points-person">
                        <div class="name">Jazz</div>
                        <div class="points" id="jazz-week-points">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h2>Daily Exercise</h2>
                <div class="time-range-buttons">
                    <button class="time-btn active" onclick="changeTimeRange('exercise', '7d', this)">Week</button>
                    <button class="time-btn" onclick="changeTimeRange('exercise', '30d', this)">Month</button>
                    <button class="time-btn" onclick="changeTimeRange('exercise', '90d', this)">3 Months</button>
                </div>
            </div>
            <div class="chart-canvas-container">
                <canvas id="exerciseChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h2>Weight Tracking</h2>
                <div class="time-range-buttons">
                    <button class="time-btn active" onclick="changeTimeRange('weight', '7d', this)">Week</button>
                    <button class="time-btn" onclick="changeTimeRange('weight', '30d', this)">Month</button>
                    <button class="time-btn" onclick="changeTimeRange('weight', '90d', this)">3 Months</button>
                </div>
            </div>
            <div class="chart-canvas-container">
                <canvas id="weightChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <h2>Drinking Days This Week</h2>
            <div class="week-drinks" id="weekDrinks"></div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Entry</h2>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="modal-date" readonly />
                </div>
                <div class="input-group">
                    <label>Drinks</label>
                    <input type="number" id="modal-drinks" min="0" />
                </div>
                <div class="input-group">
                    <label>Exercise (minutes)</label>
                    <input type="number" id="modal-exercise" min="0" />
                </div>
                <div class="input-group">
                    <label>Weight (kg)</label>
                    <input type="number" id="modal-weight" min="0" step="0.1" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ============================================
        // IMPORTANT: Replace these with your Firebase config values
        // ============================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Data storage
        let data = {
            hamish: {},
            jazz: {}
        };
        
        let currentEditPerson = null;
        let currentEditDate = null;
        let chartRanges = {
            exercise: '7d',
            weight: '7d'
        };
        
        // Set up real-time listeners
        function setupFirebaseListeners() {
            // Listen for changes to Hamish's data
            database.ref('hamish').on('value', (snapshot) => {
                data.hamish = snapshot.val() || {};
                updateCharts();
                updateStats();
                console.log('Hamish data updated from Firebase');
            });
            
            // Listen for changes to Jazz's data
            database.ref('jazz').on('value', (snapshot) => {
                data.jazz = snapshot.val() || {};
                updateCharts();
                updateStats();
                console.log('Jazz data updated from Firebase');
            });
            
            // Update connection status
            database.ref('.info/connected').on('value', (snapshot) => {
                const status = document.getElementById('syncStatus');
                const text = document.getElementById('syncText');
                if (snapshot.val() === true) {
                    status.className = 'sync-status connected';
                    text.textContent = '✅ Connected - All changes sync automatically';
                } else {
                    status.className = 'sync-status error';
                    text.textContent = '⚠️ Offline - Changes will sync when reconnected';
                }
            });
        }
        
        // Save data to Firebase
        function saveToFirebase(person, date, entry) {
            return database.ref(`${person}/${date}`).set(entry)
                .then(() => {
                    console.log(`Data saved to Firebase for ${person} on ${date}`);
                })
                .catch((error) => {
                    console.error('Error saving to Firebase:', error);
                    alert('Error saving data. Please check your connection.');
                });
        }
        
        // Set today's date on load
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('hamish-date').value = today;
            document.getElementById('jazz-date').value = today;
        }
        
        // Save data for a person
        async function saveData(person) {
            const date = document.getElementById(`${person}-date`).value;
            const drinks = parseInt(document.getElementById(`${person}-drinks`).value) || 0;
            const exercise = parseInt(document.getElementById(`${person}-exercise`).value) || 0;
            const weightInput = document.getElementById(`${person}-weight`).value;
            const weight = weightInput ? parseFloat(weightInput) : null;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const entry = {
                drinks: drinks,
                exercise: exercise
            };
            
            if (weight !== null) {
                entry.weight = weight;
            }
            
            // Save to Firebase
            await saveToFirebase(person, date, entry);
            
            // Update local data
            if (!data[person][date]) {
                data[person][date] = {};
            }
            data[person][date] = entry;
            
            // Update UI
            loadPreviousData(person);
            
            // Reset inputs
            document.getElementById(`${person}-drinks`).value = 0;
            document.getElementById(`${person}-exercise`).value = 0;
            document.getElementById(`${person}-weight`).value = '';
        }
        
        // Load previous data for editing
        function loadPreviousData(person) {
            const container = document.getElementById(`${person}-previous`);
            const entries = Object.entries(data[person]).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 10);
            
            if (entries.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 14px;">No previous entries</p>';
                return;
            }
            
            container.innerHTML = entries.map(([date, entry]) => {
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                return `
                    <div class="data-entry">
                        <span class="data-date">${formattedDate}</span>
                        <div class="data-values">
                            <span>🍺 ${entry.drinks || 0}</span>
                            <span>🏃 ${entry.exercise || 0}min</span>
                            ${entry.weight ? `<span>⚖️ ${entry.weight}kg</span>` : ''}
                            <button class="edit-btn" onclick="openEditModal('${person}', '${date}')">Edit</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Open edit modal
        function openEditModal(person, date) {
            currentEditPerson = person;
            currentEditDate = date;
            
            const entry = data[person][date] || {};
            document.getElementById('modal-date').value = date;
            document.getElementById('modal-drinks').value = entry.drinks || 0;
            document.getElementById('modal-exercise').value = entry.exercise || 0;
            document.getElementById('modal-weight').value = entry.weight || '';
            
            document.getElementById('editModal').classList.add('show');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditPerson = null;
            currentEditDate = null;
        }
        
        // Save edit
        async function saveEdit() {
            if (!currentEditPerson || !currentEditDate) return;
            
            const drinks = parseInt(document.getElementById('modal-drinks').value) || 0;
            const exercise = parseInt(document.getElementById('modal-exercise').value) || 0;
            const weightInput = document.getElementById('modal-weight').value;
            const weight = weightInput ? parseFloat(weightInput) : null;
            
            const entry = {
                drinks: drinks,
                exercise: exercise
            };
            
            if (weight !== null) {
                entry.weight = weight;
            }
            
            // Save to Firebase
            await saveToFirebase(currentEditPerson, currentEditDate, entry);
            
            // Update local data
            if (!data[currentEditPerson][currentEditDate]) {
                data[currentEditPerson][currentEditDate] = {};
            }
            data[currentEditPerson][currentEditDate] = entry;
            
            loadPreviousData(currentEditPerson);
            closeModal();
        }
        
        // Calculate points
        function calculatePoints(drinks, exerciseMinutes) {
            const drinkPoints = drinks * -11;
            const exercisePoints = Math.floor(exerciseMinutes / 5) * 5;
            return drinkPoints + exercisePoints;
        }
        
        // Get date range
        function getDateRange(range) {
            const dates = [];
            const today = new Date();
            let days = 7;
            
            if (range === '30d') days = 30;
            if (range === '90d') days = 90;
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        // Get last 7 days
        function getLast7Days() {
            return getDateRange('7d');
        }
        
        // Change time range for charts
        function changeTimeRange(chartType, range, button) {
            chartRanges[chartType] = range;
            
            // Update button states
            const buttons = button.parentElement.querySelectorAll('.time-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            updateCharts();
        }
        
        // Update charts
        function updateCharts() {
            updateExerciseChart();
            updateWeightChart();
            updateWeekDrinks();
        }
        
        function updateExerciseChart() {
            const dateRange = getDateRange(chartRanges.exercise);
            
            // Exercise chart data
            const hamishExercise = dateRange.map(date => data.hamish[date]?.exercise || 0);
            const jazzExercise = dateRange.map(date => data.jazz[date]?.exercise || 0);
            
            // Get or create canvas element
            let canvas = document.getElementById('exerciseChart');
            if (!canvas) {
                console.error('Exercise canvas element not found');
                return;
            }
            
            // Destroy existing chart if it exists
            if (window.exerciseChart && typeof window.exerciseChart.destroy === 'function') {
                window.exerciseChart.destroy();
                window.exerciseChart = null;
            }
            
            // Format labels based on range
            const labels = dateRange.map(date => {
                const d = new Date(date + 'T00:00:00');
                if (chartRanges.exercise === '7d') {
                    return d.toLocaleDateString('en', { weekday: 'short', month: 'short', day: 'numeric' });
                } else if (chartRanges.exercise === '30d') {
                    return d.toLocaleDateString('en', { month: 'short', day: 'numeric' });
                } else {
                    return d.toLocaleDateString('en', { month: 'short', day: 'numeric' });
                }
            });
            
            // Show every nth label for longer ranges
            const skipLabels = chartRanges.exercise === '30d' ? 3 : chartRanges.exercise === '90d' ? 7 : 1;
            
            // Create new chart
            try {
                const ctx = canvas.getContext('2d');
                window.exerciseChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Hamish',
                            data: hamishExercise,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: chartRanges.exercise === '90d' ? 0 : 4,
                            pointHoverRadius: 6
                        }, {
                            label: 'Jazz',
                            data: jazzExercise,
                            borderColor: 'rgb(236, 72, 153)',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: chartRanges.exercise === '90d' ? 0 : 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' minutes';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value, index) {
                                        return index % skipLabels === 0 ? this.getLabelForValue(value) : '';
                                    },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Minutes',
                                    font: {
                                        size: 12
                                    }
                                },
                                ticks: {
                                    stepSize: 10,
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating exercise chart:', error);
            }
        }
        
        function updateWeightChart() {
            const dateRange = getDateRange(chartRanges.weight);
            
            // Weight chart data - filter out null/undefined values
            const hamishWeightData = [];
            const jazzWeightData = [];
            const weightLabels = [];
            
            dateRange.forEach(date => {
                const hamishWeight = data.hamish[date]?.weight;
                const jazzWeight = data.jazz[date]?.weight;
                
                if (hamishWeight !== undefined || jazzWeight !== undefined) {
                    weightLabels.push(date);
                    hamishWeightData.push(hamishWeight || null);
                    jazzWeightData.push(jazzWeight || null);
                }
            });
            
            // Get or create canvas element
            let canvas = document.getElementById('weightChart');
            if (!canvas) {
                console.error('Weight canvas element not found');
                return;
            }
            
            // Destroy existing chart if it exists
            if (window.weightChart && typeof window.weightChart.destroy === 'function') {
                window.weightChart.destroy();
                window.weightChart = null;
            }
            
            // Format labels
            const formattedLabels = weightLabels.map(date => {
                const d = new Date(date + 'T00:00:00');
                if (chartRanges.weight === '7d') {
                    return d.toLocaleDateString('en', { weekday: 'short', month: 'short', day: 'numeric' });
                } else {
                    return d.toLocaleDateString('en', { month: 'short', day: 'numeric' });
                }
            });
            
            // Create new chart
            try {
                const ctx = canvas.getContext('2d');
                window.weightChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: formattedLabels,
                        datasets: [{
                            label: 'Hamish',
                            data: hamishWeightData,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            spanGaps: true
                        }, {
                            label: 'Jazz',
                            data: jazzWeightData,
                            borderColor: 'rgb(236, 72, 153)',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            spanGaps: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        if (context.parsed.y !== null) {
                                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + ' kg';
                                        }
                                        return context.dataset.label + ': No data';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Weight (kg)',
                                    font: {
                                        size: 12
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating weight chart:', error);
            }
        }
        
        function updateWeekDrinks() {
            const last7Days = getLast7Days();
            
            // Update drinking days
            const weekDrinksDiv = document.getElementById('weekDrinks');
            weekDrinksDiv.innerHTML = '';
            
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            last7Days.forEach(date => {
                const d = new Date(date + 'T00:00:00');
                const dayName = dayNames[d.getDay()];
                const hamishDrinks = data.hamish[date]?.drinks || 0;
                const jazzDrinks = data.jazz[date]?.drinks || 0;
                const totalDrinks = hamishDrinks + jazzDrinks;
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `day-indicator ${totalDrinks > 0 ? 'has-drinks' : 'no-drinks'}`;
                dayDiv.innerHTML = `
                    <div class="day-name">${dayName}</div>
                    <div class="drink-count">
                        ${totalDrinks > 0 ? `🍺 ${totalDrinks}` : '✅'}
                    </div>
                    <div style="font-size: 0.8em; margin-top: 5px;">
                        H: ${hamishDrinks} | J: ${jazzDrinks}
                    </div>
                `;
                weekDrinksDiv.appendChild(dayDiv);
            });
        }
        
        // Update stats
        function updateStats() {
            // Calculate total points
            let hamishTotal = 0;
            let jazzTotal = 0;
            let hamishWeek = 0;
            let jazzWeek = 0;
            
            const last7Days = getLast7Days();
            
            // Calculate all-time points
            Object.entries(data.hamish).forEach(([date, entry]) => {
                const points = calculatePoints(entry.drinks || 0, entry.exercise || 0);
                hamishTotal += points;
                if (last7Days.includes(date)) {
                    hamishWeek += points;
                }
            });
            
            Object.entries(data.jazz).forEach(([date, entry]) => {
                const points = calculatePoints(entry.drinks || 0, entry.exercise || 0);
                jazzTotal += points;
                if (last7Days.includes(date)) {
                    jazzWeek += points;
                }
            });
            
            // Update displays
            const hamishTotalEl = document.getElementById('hamish-total-points');
            const jazzTotalEl = document.getElementById('jazz-total-points');
            const hamishWeekEl = document.getElementById('hamish-week-points');
            const jazzWeekEl = document.getElementById('jazz-week-points');
            
            hamishTotalEl.textContent = hamishTotal;
            hamishTotalEl.className = `points ${hamishTotal > 0 ? 'points-positive' : hamishTotal < 0 ? 'points-negative' : 'points-neutral'}`;
            
            jazzTotalEl.textContent = jazzTotal;
            jazzTotalEl.className = `points ${jazzTotal > 0 ? 'points-positive' : jazzTotal < 0 ? 'points-negative' : 'points-neutral'}`;
            
            hamishWeekEl.textContent = hamishWeek;
            hamishWeekEl.className = `points ${hamishWeek > 0 ? 'points-positive' : hamishWeek < 0 ? 'points-negative' : 'points-neutral'}`;
            
            jazzWeekEl.textContent = jazzWeek;
            jazzWeekEl.className = `points ${jazzWeek > 0 ? 'points-positive' : jazzWeek < 0 ? 'points-negative' : 'points-neutral'}`;
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Initialize
        setTodayDate();
        setupFirebaseListeners();
    </script>
</body>
</html>
